<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dq.aquaranth.userRole.mapper.UserRoleMapper">

    <select id="findCompany" resultType="com.dq.aquaranth.userRole.dto.UserRoleCompanyDTO">
        select company_no, company_name
        from tbl_company
        where company_no = #{companyNo}
    </select>

    <select id="findRoleGroupByCompanyName" resultType="com.dq.aquaranth.userRole.dto.UserRoleRoleGroupBasedListDTO">
        select trg.role_group_no, trg.role_group_name, trg.company_no, tc.company_name
        from tbl_role_group trg
        left join tbl_company tc on trg.company_no = tc.company_no
        where trg.role_group_use = true
        and trg.company_no = #{companyNo}
        <if test="roleGroupSearch != null">
            and trg.role_group_name like concat('%', #{roleGroupSearch}, '%')
        </if>
    </select>

    <select id="findOrgaByRoleGroupNo" resultType="com.dq.aquaranth.userRole.dto.UserRoleGroupBasedUserListDTO">
        SELECT FN_GET_HIERARCHY_ORGA(case when rg.orga_type = 'emp' then rg.upper_orga_no else rg.orga_no end) orga_info
             , tem.emp_rank
             , te.emp_name
             , te.username
             , rg.orga_no
        FROM (
                 SELECT trg.role_group_no
                      , trg.role_group_name
                      , trg.company_no
                      , tor.orga_role_no
                      , tor.orga_no
                      , to2.upper_orga_no
                      , to2.orga_type
                 FROM tbl_role_group trg
                          LEFT JOIN tbl_orga_role tor ON tor.role_group_no = trg.role_group_no
                          LEFT JOIN tbl_orga to2 ON to2.orga_no = tor.orga_no
                 WHERE trg.role_group_use = true
                   AND trg.role_group_no = ${roleGroupNo}
                   AND trg.company_no = ${companyNo}
             ) rg
                 JOIN tbl_orga og ON og.orga_no = rg.orga_no
                 LEFT JOIN tbl_emp_mapping tem ON tem.orga_no = og.orga_no
                 LEFT JOIN tbl_emp te ON te.emp_no = tem.emp_no
                 LEFT JOIN tbl_dept_mapping tdm ON og.upper_orga_no = tdm.orga_no
                 LEFT JOIN tbl_dept td ON tdm.dept_no = td.dept_no
        <if test="userListSearch != null and userListSearch != ''">
        WHERE (
                 td.dept_name LIKE CONCAT('%', ${userListSearch}, '%') OR
                 tem.emp_rank LIKE CONCAT('%', ${userListSearch}, '%') OR
                 te.emp_name  LIKE CONCAT('%', ${userListSearch}, '%') OR
                 te.username  LIKE CONCAT('%', ${userListSearch}, '%')
              )
        </if>
    </select>
</mapper>
